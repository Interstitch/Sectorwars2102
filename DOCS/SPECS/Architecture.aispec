OVERVIEW:
Sector Wars 2102 uses a microservices architecture with three separate services: Game API Server, Player Client, and Admin UI, all connecting to a remote PostgreSQL database. Services deployed as Docker containers with support for multiple deployment profiles (development, multi-regional, production, monitoring).

FACTS:
* Docker-based containerization for all deployments
* Multiple deployment profiles via Docker Compose:
  * Development profile (default, local dev with hot reload)
  * Multi-regional profile (testing regional architecture)
  * Production profile (security-hardened, resource limits)
  * Monitoring profile (Prometheus + Grafana)
* Remote Neon PostgreSQL database for persistence across environments
* Microservices communicate via RESTful API calls
* Game logic resides exclusively in the Game API server
* Environment detection determines runtime configuration (local vs Codespaces)
* Python FastAPI backend with Uvicorn server
* React with TypeScript frontend services (Vite bundler)
* Nginx reverse proxy for production deployments
* Redis for cross-regional coordination in multi-regional mode

TERMINOLOGY:
* Game API Server: Core backend service containing all game logic and database operations
* Player Client: Web interface for playing the game
* Admin UI: Specialized interface for game universe administration
* Environment Detection: System to identify whether code is running in local or GitHub Codespaces environment
* Docker Compose Profile: Named configuration subset for specific deployment scenarios
* Multi-Regional Architecture: Player-owned Regional Territories coordinated via Redis
* Microservices: Independent services communicating via REST API

FILES:
- /
  â”œâ”€â”€ docker-compose.yml          # Unified Docker Compose with profiles
  â”œâ”€â”€ .devcontainer/              # GitHub Codespaces configuration
  â”‚   â””â”€â”€ devcontainer.json
  â”œâ”€â”€ .env                        # Environment variables (not in git)
  â”œâ”€â”€ CLAUDE.md                   # AI assistant configuration
  â”œâ”€â”€ tests/                      # Central testing directory
  â”‚   â”œâ”€â”€ e2e_tests/              # Centralized E2E tests
  â”‚   â”‚   â”œâ”€â”€ admin/              # Admin UI tests
  â”‚   â”‚   â”‚   â””â”€â”€ ui/             # Admin UI test files
  â”‚   â”‚   â”œâ”€â”€ player/             # Player client tests
  â”‚   â”‚   â”‚   â””â”€â”€ ui/             # Player client test files
  â”‚   â”‚   â”œâ”€â”€ fixtures/           # Shared test fixtures
  â”‚   â”‚   â”œâ”€â”€ utils/              # Shared utility functions
  â”‚   â”‚   â”œâ”€â”€ playwright.config.ts # Playwright configuration
  â”‚   â”‚   â”œâ”€â”€ test-explorer.config.ts # VS Code Test Explorer config
  â”‚   â”‚   â””â”€â”€ run_all_tests.sh    # Script to run all E2E tests
  â”‚   â””â”€â”€ test-results/           # Test reports and artifacts
  â”œâ”€â”€ dev-scripts/                # Development utility scripts
  â”‚   â”œâ”€â”€ setup.sh                # Unified setup script
  â”‚   â””â”€â”€ start-unified.sh        # Environment detection and startup
  â”œâ”€â”€ services/
  â”‚   â”œâ”€â”€ gameserver/            # Game API Server component
  â”‚   â”‚   â”œâ”€â”€ Dockerfile
  â”‚   â”‚   â”œâ”€â”€ requirements.txt
  â”‚   â”‚   â”œâ”€â”€ pyproject.toml     # Python project configuration
  â”‚   â”‚   â”œâ”€â”€ src/
  â”‚   â”‚   â”‚   â”œâ”€â”€ main.py        # Application entry point
  â”‚   â”‚   â”‚   â”œâ”€â”€ api/           # API routes and middleware
  â”‚   â”‚   â”‚   â”œâ”€â”€ auth/          # Authentication system
  â”‚   â”‚   â”‚   â”œâ”€â”€ models/        # Database models
  â”‚   â”‚   â”‚   â”œâ”€â”€ schemas/       # API schema definitions
  â”‚   â”‚   â”‚   â”œâ”€â”€ services/      # Business logic
  â”‚   â”‚   â”‚   â”œâ”€â”€ core/          # Core infrastructure
  â”‚   â”‚   â”‚   â””â”€â”€ utils/         # Utility functions
  â”‚   â”‚   â”œâ”€â”€ tests/             # Test suite
  â”‚   â”‚   â”‚   â”œâ”€â”€ api/           # API tests
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ test_auth_routes.py
  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ test_users_routes.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ conftest.py    # Test fixtures and configuration
  â”‚   â”‚   â”‚   â”œâ”€â”€ mock_app.py    # Mock application for testing
  â”‚   â”‚   â”‚   â”œâ”€â”€ mock_config.py # Test configuration
  â”‚   â”‚   â”‚   â””â”€â”€ run_tests.sh   # Test runner script
  â”‚   â”‚   â””â”€â”€ alembic/           # Database migrations
  â”‚   â”œâ”€â”€ player-client/         # Player web interface
  â”‚   â”‚   â”œâ”€â”€ Dockerfile
  â”‚   â”‚   â”œâ”€â”€ package.json
  â”‚   â”‚   â”œâ”€â”€ playwright.config.ts # Playwright test configuration
  â”‚   â”‚   â”œâ”€â”€ run_tests.sh       # Test runner script
  â”‚   â”‚   â”œâ”€â”€ src/
  â”‚   â”‚   â”‚   â”œâ”€â”€ main.tsx       # Application entry point
  â”‚   â”‚   â”‚   â”œâ”€â”€ App.tsx        # Root component
  â”‚   â”‚   â”‚   â”œâ”€â”€ auth/          # Authentication components
  â”‚   â”‚   â”‚   â”œâ”€â”€ components/    # Reusable UI components
  â”‚   â”‚   â”‚   â”œâ”€â”€ pages/         # Page components
  â”‚   â”‚   â”‚   â”œâ”€â”€ services/      # API client services
  â”‚   â”‚   â”‚   â””â”€â”€ types/         # TypeScript type definitions
  â”‚   â”œâ”€â”€ admin-ui/              # Admin interface
  â”‚   â”‚   â”œâ”€â”€ Dockerfile
  â”‚   â”‚   â”œâ”€â”€ package.json
  â”‚   â”‚   â”œâ”€â”€ src/
  â”‚   â”‚   â”‚   â”œâ”€â”€ main.tsx       # Application entry point
  â”‚   â”‚   â”‚   â”œâ”€â”€ App.tsx        # Root component
  â”‚   â”‚   â”‚   â”œâ”€â”€ auth/          # Admin authentication
  â”‚   â”‚   â”‚   â”œâ”€â”€ components/    # Reusable UI components
  â”‚   â”‚   â”‚   â”œâ”€â”€ pages/         # Admin pages
  â”‚   â”‚   â”‚   â”œâ”€â”€ services/      # API client services
  â”‚   â”‚   â”‚   â””â”€â”€ types/         # TypeScript type definitions
  â”‚   â”‚   â””â”€â”€ scripts/
  â”‚   â”‚       â””â”€â”€ run-tests.js   # Test runner script
  â”‚   â”œâ”€â”€ playwright-admin/      # Playwright admin tests
  â”‚   â”‚   â”œâ”€â”€ e2e/               # End-to-end tests for admin
  â”‚   â”‚   â”œâ”€â”€ fixtures/          # Test fixtures
  â”‚   â”‚   â”œâ”€â”€ utils/             # Test utilities
  â”‚   â”‚   â”œâ”€â”€ playwright.config.ts # Playwright configuration
  â”‚   â”‚   â””â”€â”€ run_tests.sh       # Test runner script
  â”‚   â””â”€â”€ playwright-player/     # Playwright player tests
  â”‚       â”œâ”€â”€ e2e/               # End-to-end tests for player client
  â”‚       â”œâ”€â”€ fixtures/          # Test fixtures
  â”‚       â”œâ”€â”€ utils/             # Test utilities
  â”‚       â”œâ”€â”€ playwright.config.ts # Playwright configuration
  â”‚       â””â”€â”€ run_tests.sh       # Test runner script
  â””â”€â”€ DOCS/
      â”œâ”€â”€ FEATURE_DOCS/         # Feature documentation
      â”‚   â”œâ”€â”€ TESTING.md        # Comprehensive testing guide
      â”‚   â””â”€â”€ E2E_TESTING.md    # End-to-End testing guide (deprecated)
      â”œâ”€â”€ DATA_DEFS/            # Data Definitions and Models
      â””â”€â”€ AISPEC/               # AI assistant documentation
          â”œâ”€â”€ Architecture.aispec   # Overall architecture
          â”œâ”€â”€ Database.aispec       # Database schema
          â”œâ”€â”€ GameServer.aispec     # Game server details
          â””â”€â”€ AuthSystem.aispec     # Authentication system

SCHEMA:
No database schema directly associated with architecture. See Database.aispec for schema details.

CONSTRAINTS:
* Game logic must remain exclusively in the Game API Server
* Frontend services must not contain business logic
* All persistent data must be stored in external PostgreSQL database (Neon)
* Environment variables must be used for configuration
* Services must function in both local and Codespaces environments without code changes
* All deployments must use Docker for consistency
* Secrets must not be stored in version control (.env excluded from git)
* Multi-regional deployments require Redis for coordination
* Production deployments require Nginx reverse proxy

EXAMPLES:
```bash
# Development Profile (default) - Local development with hot reload
docker-compose up
# Services: database, gameserver, player-client, admin-ui

# Multi-Regional Profile - Testing regional architecture
docker-compose --profile multi-regional up
# Services: central-nexus-db, redis-nexus, central-nexus-server,
#           player-client, admin-ui, nginx-gateway, region-manager

# Production Profile - Security-hardened deployment
docker-compose --profile production up
# Services: central-nexus-db, redis-nexus, central-nexus-server,
#           player-client, admin-ui, nginx-gateway

# Production with Monitoring
docker-compose --profile production --profile monitoring up
# Adds: prometheus, grafana

# Start Individual Service
docker-compose up gameserver
docker-compose up player-client

# Run Commands Inside Containers
docker-compose exec gameserver poetry run pytest
docker-compose exec player-client npm run typecheck
docker-compose exec admin-ui npm run build

# View Service Logs
docker-compose logs -f gameserver
docker-compose logs -f player-client
```

```yaml
# docker-compose.yml - Service definitions
version: '3.8'
services:
  gameserver:
    build:
      context: ./services/gameserver
      dockerfile: Dockerfile
    ports:
      - "${GAMESERVER_PORT:-8080}:8080"
    volumes:
      - ./services/gameserver:/app
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - PYTHONUNBUFFERED=1
    profiles: ["development"]

  player-client:
    build:
      context: ./services/player-client
      dockerfile: Dockerfile
    ports:
      - "${PLAYER_CLIENT_PORT:-3000}:3000"
    volumes:
      - ./services/player-client:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=${API_BASE_URL}
    depends_on:
      - gameserver
    profiles: ["development", "multi-regional", "production"]

  admin-ui:
    build:
      context: ./services/admin-ui
      dockerfile: Dockerfile
    ports:
      - "${ADMIN_UI_PORT:-3001}:3001"
    volumes:
      - ./services/admin-ui:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=${API_BASE_URL}
    depends_on:
      - gameserver
    profiles: ["development", "multi-regional", "production"]

  redis-nexus:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    profiles: ["multi-regional", "production"]

  nginx-gateway:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - gameserver
    profiles: ["multi-regional", "production"]
```

```bash
# Environment Detection and Startup
#!/bin/bash

detect_environment() {
  if [ -n "$CODESPACE_NAME" ] || [ -n "$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN" ]; then
    echo "codespaces"
  else
    echo "local"
  fi
}

ENV=$(detect_environment)
echo "ðŸš€ Detected environment: $ENV"

case "$ENV" in
  "codespaces")
    echo "Starting in GitHub Codespaces"
    docker-compose up
    ;;
  "local")
    echo "Starting in local environment"
    docker-compose up
    ;;
esac
```

```bash
# Service Communication Patterns

# Player Client â†’ Game Server (REST API)
fetch('http://gameserver:8080/api/v1/players/me', {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
})

# Admin UI â†’ Game Server (REST API)
fetch('http://gameserver:8080/api/v1/admin/users', {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${adminToken}`,
    'Content-Type': 'application/json'
  }
})

# Game Server â†’ Database (SQLAlchemy)
from sqlalchemy import select
from models import Player

result = await session.execute(
  select(Player).where(Player.id == player_id)
)
player = result.scalar_one_or_none()

# Multi-Regional Coordination (Redis)
import redis
r = redis.Redis(host='redis-nexus', port=6379)
r.publish('regional-events', json.dumps({
  'event': 'player_joined',
  'region': 'territory-1',
  'player_id': player_id
}))
```